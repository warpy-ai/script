// ============================================================================
// Test: Bootstrap Emitter
// Requires: std/prelude.tscl, bootstrap/lexer.tscl, bootstrap/parser.tscl,
//           bootstrap/emitter.tscl to be loaded first
// ============================================================================

console.log("=== Testing Emitter ===");

// Quick sanity check that prelude is available
console.log("Prelude check: TOKEN.NUMBER =", TOKEN.NUMBER, ", isDigit(49) =", isDigit(49));

// Test 1: Simple expression 1 + 2
console.log("\nTest 1: Compiling '1 + 2'");
let bytecode1 = compile("1 + 2;");
if (bytecode1 != null) {
    console.log("Success! Bytecode length:", Bytes.length(bytecode1));
    console.log("Bytecode:", Bytes.toArray(bytecode1));
    File.writeBinarySync("test1.tscl.bc", bytecode1);
    console.log("Written to test1.tscl.bc");
} else {
    console.log("Failed to compile!");
}

// Test 2: Variable declaration
console.log("\nTest 2: Compiling 'let x = 42;'");
let bytecode2 = compile("let x = 42;");
if (bytecode2 != null) {
    console.log("Success! Bytecode length:", Bytes.length(bytecode2));
    console.log("Bytecode:", Bytes.toArray(bytecode2));
}

// Test 3: More complex expression with precedence
console.log("\nTest 3: Compiling '1 + 2 * 3'");
let bytecode3 = compile("1 + 2 * 3;");
if (bytecode3 != null) {
    console.log("Success! Bytecode length:", Bytes.length(bytecode3));
    console.log("Bytecode:", Bytes.toArray(bytecode3));
}

// Test 4: Function declaration
console.log("\nTest 4: Compiling function");
let funcSrc = "function add(a, b) { return a + b; }";
let bytecode4 = compile(funcSrc);
if (bytecode4 != null) {
    console.log("Success! Bytecode length:", Bytes.length(bytecode4));
}

// Test 5: If statement
console.log("\nTest 5: Compiling if statement");
let ifSrc = "if (x > 0) { return true; } else { return false; }";
let bytecode5 = compile(ifSrc);
if (bytecode5 != null) {
    console.log("Success! Bytecode length:", Bytes.length(bytecode5));
}

// Test 6: While loop
console.log("\nTest 6: Compiling while loop");
let whileSrc = "while (i < 10) { i = i + 1; }";
let bytecode6 = compile(whileSrc);
if (bytecode6 != null) {
    console.log("Success! Bytecode length:", Bytes.length(bytecode6));
}

// Test 7: Object literal
console.log("\nTest 7: Compiling object literal");
let objSrc = "let obj = { name: \"test\", value: 42 };";
let bytecode7 = compile(objSrc);
if (bytecode7 != null) {
    console.log("Success! Bytecode length:", Bytes.length(bytecode7));
}

// Test 8: Array literal
console.log("\nTest 8: Compiling array literal");
let arrSrc = "let arr = [1, 2, 3];";
let bytecode8 = compile(arrSrc);
if (bytecode8 != null) {
    console.log("Success! Bytecode length:", Bytes.length(bytecode8));
}

console.log("\n=== All emitter tests completed! ===");
