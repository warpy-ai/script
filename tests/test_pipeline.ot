// ============================================================================
// Pipeline Test Suite
// ============================================================================
// Tests bytecode determinism using representative programs.
// Full bootstrap module compilation is tested separately in
// verify_self_compilation and verify_bootstrap_loop stages.
// ============================================================================

require("../bootstrap/pipeline");

// Representative test programs that cover key language features
// Note: All programs must end with semicolons where needed, because the
// bootstrap parser requires them (unlike the SWC/Rust parser).
let TEST_PROGRAMS = [
    "1 + 2 * 3;",
    "let x = 42; let y = x + 1;",
    "function add(a, b) { return a + b; } add(2, 3);",
    "function fib(n) { if (n <= 1) { return n; } return fib(n - 1) + fib(n - 2); } fib(10);",
    "let i = 0; let sum = 0; while (i < 10) { sum = sum + i; i = i + 1; }",
    "let s = \"hello\"; let t = s + \" world\";",
    "let arr = [1, 2, 3]; let obj = { x: 1, y: 2 };",
    "function outer() { function inner(x) { return x * 2; } return inner(5); } outer();",
    "let a = true; let b = false; if (a && !b) { let c = 1; } else { let c = 2; }",
    "function isPrime(n) { if (n <= 1) { return false; } if (n <= 3) { return true; } let i = 2; while (i * i <= n) { if (n - (n / i) * i == 0) { return false; } i = i + 1; } return true; }"
];

let TEST_NAMES = [
    "arithmetic",
    "variables",
    "function_call",
    "recursion",
    "while_loop",
    "strings",
    "array_object",
    "nested_functions",
    "boolean_logic",
    "complex_function"
];

console.log("==============================================");
console.log("Pipeline Test Suite");
console.log("==============================================");
console.log("");

let allPassed = true;

function testSimpleExpression() {
    console.log("Test: Simple Expression");

    let result = compileToBytecode("1 + 2 * 3;");

    if (result == null || result.length <= 0) {
        console.log("FAIL: Compilation failed");
        return false;
    }

    console.log("  PASS: Simple expression compiles");
    console.log("    Bytecode: " + result.length + " bytes");
    return true;
}

function testVariableDeclaration() {
    console.log("Test: Variable Declaration");

    let result = compileToBytecode("let x = 42;");

    if (result == null) {
        console.log("FAIL: Compilation failed");
        return false;
    }

    console.log("  PASS: Variable declaration compiles");
    console.log("    Bytecode: " + result.length + " bytes");
    return true;
}

function testFunctionDeclaration() {
    console.log("Test: Function Declaration");

    let result = compileToBytecode("function add(a, b) { return a + b; }");

    if (result == null) {
        console.log("FAIL: Compilation failed");
        return false;
    }

    console.log("  PASS: Function declaration compiles");
    console.log("    Bytecode: " + result.length + " bytes");
    return true;
}

function testFullPipeline() {
    console.log("Test: Full Pipeline Metrics");

    let metrics = measureCompilation("let x = 1; let y = 2; x + y;");

    if (metrics == null) {
        console.log("FAIL: Metrics failed");
        return false;
    }

    console.log("  PASS: Full pipeline metrics collected");
    console.log("    Bytecode: " + metrics.bytecodeSize + " bytes");
    return true;
}

function testModuleCompilation() {
    console.log("Test: Module Compilation");

    let source = "function isPrime(n) { if (n <= 1) { return false; } if (n <= 3) { return true; } return true; }";
    let result = compileModule(source);

    if (result == null) {
        console.log("FAIL: Module compilation failed");
        return false;
    }

    console.log("  PASS: Module compiles successfully");
    console.log("    Bytecode: " + result.length + " bytes");
    return true;
}

function testBootstrapCompilerVersion() {
    console.log("Test: Bootstrap Compiler Version");

    if (BootstrapCompiler.version != "0.1.0") {
        console.log("FAIL: Version mismatch");
        return false;
    }

    console.log("  PASS: Bootstrap compiler version correct");
    console.log("    Version: " + BootstrapCompiler.version);
    console.log("    Pipeline: " + BootstrapCompiler.pipeline);
    return true;
}

function runAllPipelineTests() {
    console.log("Running Pipeline Tests...\n");

    if (!testSimpleExpression()) { allPassed = false; }
    console.log("");

    if (!testVariableDeclaration()) { allPassed = false; }
    console.log("");

    if (!testFunctionDeclaration()) { allPassed = false; }
    console.log("");

    if (!testFullPipeline()) { allPassed = false; }
    console.log("");

    if (!testModuleCompilation()) { allPassed = false; }
    console.log("");

    if (!testBootstrapCompilerVersion()) { allPassed = false; }
    console.log("");

    console.log("==============================================");
    if (allPassed) {
        console.log("All Pipeline tests passed!");
    } else {
        console.log("Some Pipeline tests failed!");
    }
    console.log("==============================================");
}

runAllPipelineTests();

// ============================================================================
// Self-Hosting Bootstrap Tests
// ============================================================================

console.log("");
console.log("==============================================");
console.log("Self-Hosting Bootstrap Tests");
console.log("==============================================");
console.log("");

function testBootstrapLoads() {
    console.log("Test: Bootstrap compiler loads");
    if (BootstrapCompiler == null) {
        console.log("  FAIL");
        return false;
    }
    if (BootstrapCompiler.version != "0.1.0") {
        console.log("  FAIL");
        return false;
    }
    console.log("  PASS");
    return true;
}

function testPipelineSimple() {
    console.log("Test: Pipeline compiles simple expression");
    let result = compileToBytecode("let x = 1 + 2;");
    if (result == null) {
        console.log("  FAIL");
        return false;
    }
    console.log("  PASS");
    return true;
}

function testPipelineFunction() {
    console.log("Test: Pipeline compiles function");
    let result = compileToBytecode("function add(a, b) { return a + b; }");
    if (result == null) {
        console.log("  FAIL");
        return false;
    }
    console.log("  PASS");
    return true;
}

function testRepresentativePrograms() {
    console.log("Test: Representative programs compile");
    let allCompiled = true;
    let i = 0;
    while (i < TEST_PROGRAMS.length) {
        let result = compileToBytecode(TEST_PROGRAMS[i]);
        if (result == null) {
            console.log("  FAIL: Could not compile " + TEST_NAMES[i]);
            allCompiled = false;
        }
        i = i + 1;
    }
    if (allCompiled) {
        console.log("  PASS: All " + TEST_PROGRAMS.length + " programs compiled successfully");
    }
    return allCompiled;
}

let loopPassed = true;
if (!testBootstrapLoads()) { loopPassed = false; }
console.log("");
if (!testPipelineSimple()) { loopPassed = false; }
console.log("");
if (!testPipelineFunction()) { loopPassed = false; }
console.log("");
if (!testRepresentativePrograms()) { loopPassed = false; }
console.log("");

console.log("==============================================");
if (loopPassed) {
    console.log("All Self-Hosting tests passed!");
} else {
    console.log("Some Self-Hosting tests failed!");
}
console.log("==============================================");

// ============================================================================
// Bootstrap Loop Verification (using representative programs)
// ============================================================================

console.log("");
console.log("==============================================");
console.log("Bootstrap Loop Verification");
console.log("==============================================");
console.log("");

function testBootstrapLoop() {
    console.log("==============================================");
    console.log("Bootstrap Loop Verification");
    console.log("==============================================");
    console.log("");

    let allPassed = true;

    // Test representative programs
    let i = 0;
    while (i < TEST_PROGRAMS.length) {
        let source = TEST_PROGRAMS[i];
        let bytecodeA = compileToBytecode(source);
        let bytecodeB = compileToBytecode(source);

        if (bytecodeA == null || bytecodeB == null) {
            console.log("  FAIL: " + TEST_NAMES[i] + " - compilation failed");
            allPassed = false;
        } else if (bytecodeA.length != bytecodeB.length) {
            console.log("  FAIL: " + TEST_NAMES[i] + " - non-deterministic output (" + bytecodeA.length + " vs " + bytecodeB.length + ")");
            allPassed = false;
        } else {
            console.log("  " + TEST_NAMES[i] + ": " + bytecodeA.length + " bytes (deterministic)");
        }
        i = i + 1;
    }

    // Test bootstrap/types.ot (the bootstrap module that self-compiles)
    console.log("");
    console.log("  Bootstrap module: types.ot");
    let typesSource = fs.readFileSync("bootstrap/types.ot", "utf8");
    let typesA = compileToBytecode(typesSource);
    let typesB = compileToBytecode(typesSource);
    if (typesA == null || typesB == null) {
        console.log("  FAIL: bootstrap/types.ot - compilation failed");
        allPassed = false;
    } else if (typesA.length != typesB.length) {
        console.log("  FAIL: bootstrap/types.ot - non-deterministic (" + typesA.length + " vs " + typesB.length + ")");
        allPassed = false;
    } else {
        console.log("  types: " + typesA.length + " bytes (deterministic)");
    }

    console.log("");
    console.log("==============================================");
    if (allPassed) {
        console.log("Bootstrap Loop: PASS");
    } else {
        console.log("Bootstrap Loop: FAIL");
    }
    console.log("==============================================");
    return allPassed;
}

// ============================================================================
// Hash Verification Tests
// ============================================================================

function testHashVerification() {
    console.log("");
    console.log("==============================================");
    console.log("Hash Verification Tests");
    console.log("==============================================");
    console.log("");

    let allPassed = true;

    console.log("Test: Compute source string hash");
    let testStr = "Hello, Bootstrap!";
    let hash1 = computeStringHash(testStr);
    let hash2 = computeStringHash(testStr);
    if (hash1 == hash2 && hash1 != 0) {
        console.log("  Hash: " + hash1);
        console.log("  PASS: Consistent hash computation");
    } else {
        console.log("  FAIL: Hash mismatch (hash1=" + hash1 + ", hash2=" + hash2 + ")");
        allPassed = false;
    }

    console.log("");
    console.log("Test: Compile and verify bytecode consistency");
    let bytecodeA = compileToBytecode("let x = 42;");
    let bytecodeB = compileToBytecode("let x = 42;");
    if (bytecodeA == null || bytecodeB == null) {
        console.log("  FAIL: Could not compile");
        allPassed = false;
    } else if (bytecodeA.length == bytecodeB.length && bytecodeA.length > 0) {
        console.log("  Bytecode length: " + bytecodeA.length + " bytes (consistent)");
        console.log("  PASS");
    } else {
        console.log("  FAIL: Bytecode mismatch (" + bytecodeA.length + " vs " + bytecodeB.length + ")");
        allPassed = false;
    }

    console.log("");
    console.log("==============================================");
    if (allPassed) {
        console.log("Hash Verification: PASS");
    } else {
        console.log("Hash Verification: FAIL");
    }
    console.log("==============================================");

    return allPassed;
}

// ============================================================================
// Full Bootstrap Compilation Test (representative programs)
// ============================================================================

function testFullBootstrap() {
    console.log("");
    console.log("==============================================");
    console.log("Full Bootstrap Compilation Test");
    console.log("==============================================");
    console.log("");

    let totalSource = 0;
    let totalBytecode = 0;

    console.log("Compiling representative programs...");
    console.log("");

    let i = 0;
    while (i < TEST_PROGRAMS.length) {
        let source = TEST_PROGRAMS[i];
        totalSource = totalSource + source.length;

        let bytecode = compileToBytecode(source);
        if (bytecode == null) {
            console.log("FAIL: Could not compile " + TEST_NAMES[i]);
            return false;
        }

        totalBytecode = totalBytecode + bytecode.length;
        console.log("  " + TEST_NAMES[i] + ": " + source.length + " chars -> " + bytecode.length + " bytes");
        i = i + 1;
    }

    // Also compile bootstrap/types.ot as a real module test
    console.log("");
    console.log("  Bootstrap module:");
    let typesSource = fs.readFileSync("bootstrap/types.ot", "utf8");
    let typesBc = compileToBytecode(typesSource);
    if (typesBc == null) {
        console.log("  FAIL: Could not compile bootstrap/types.ot");
        return false;
    }
    console.log("  types.ot: " + typesSource.length + " chars -> " + typesBc.length + " bytes");

    console.log("");
    console.log("Total: " + (totalSource + typesSource.length) + " source chars -> " + (totalBytecode + typesBc.length) + " bytecode bytes");
    console.log("");
    console.log("==============================================");
    console.log("Full Bootstrap: PASS");
    console.log("==============================================");

    return true;
}

let loopResult = testBootstrapLoop();
let hashResult = testHashVerification();
let fullResult = testFullBootstrap();

// ============================================================================
// Hash Match Verification Test
// ============================================================================

console.log("");
console.log("==============================================");
console.log("Hash Match Verification Test");
console.log("==============================================");
console.log("");

console.log("Verifying that multiple compilations produce identical bytecode...");

function testHashMatchVerification() {
    let hashMatchPassed = true;

    console.log("Testing representative programs...");
    let i = 0;
    while (i < TEST_PROGRAMS.length) {
        let source = TEST_PROGRAMS[i];

        let bcA = compileToBytecode(source);
        let bcB = compileToBytecode(source);

        if (bcA == null || bcB == null) {
            console.log("  " + TEST_NAMES[i] + ": FAIL (compilation returned null)");
            hashMatchPassed = false;
        } else if (bcA.length == bcB.length && bcA.length > 0) {
            console.log("  " + TEST_NAMES[i] + ": MATCH (" + bcA.length + " bytes)");
        } else {
            console.log("  " + TEST_NAMES[i] + ": MISMATCH (len " + bcA.length + " vs " + bcB.length + ")");
            hashMatchPassed = false;
        }
        i = i + 1;
    }

    // Test bootstrap/types.ot determinism
    console.log("");
    console.log("Testing bootstrap module (types.ot)...");
    let typesSource = fs.readFileSync("bootstrap/types.ot", "utf8");
    let tA = compileToBytecode(typesSource);
    let tB = compileToBytecode(typesSource);
    if (tA == null || tB == null) {
        console.log("  types: FAIL (compilation failed)");
        hashMatchPassed = false;
    } else if (tA.length == tB.length && tA.length > 0) {
        console.log("  types: MATCH (" + tA.length + " bytes)");
    } else {
        console.log("  types: MISMATCH (" + tA.length + " vs " + tB.length + ")");
        hashMatchPassed = false;
    }

    console.log("");
    console.log("==============================================");
    if (hashMatchPassed) {
        console.log("Hash Match Verification: PASS");
        console.log("");
        console.log("The bootstrap compiler is DETERMINISTIC!");
    } else {
        console.log("Hash Match Verification: FAIL");
    }
    console.log("==============================================");

    return hashMatchPassed;
}

let hashMatchResult = testHashMatchVerification();

console.log("");
console.log("==============================================");
console.log("Summary");
console.log("==============================================");
console.log("Bootstrap Loop: " + (loopResult ? "PASS" : "FAIL"));
console.log("Hash Verification: " + (hashResult ? "PASS" : "FAIL"));
console.log("Full Bootstrap: " + (fullResult ? "PASS" : "FAIL"));
console.log("Hash Match: " + (hashMatchResult ? "PASS" : "FAIL"));
console.log("==============================================");
