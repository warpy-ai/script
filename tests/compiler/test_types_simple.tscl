// ============================================================================
// Simple Test: Structural Type Checking
// ============================================================================

console.log("Testing structural type checker...");

// Test 1: Parse a simple program and type check it
let source1 = "let x: number = 42;";
console.log("Test 1: " + source1);

let ast1 = parseSource(source1);
if (ast1 == null) {
    console.log("  FAIL: Parse failed");
} else {
    console.log("  Parsed successfully, " + ast1.body.length + " statements");
    let result1 = Passes.structuralTypeCheck(ast1);
    console.log("  Type check complete, " + result1.errors.length + " errors");
    if (result1.errors.length == 0) {
        console.log("  PASS: No type errors (expected)");
    } else {
        console.log("  FAIL: Unexpected errors");
    }
}

// Test 2: Type mismatch should produce error
let source2 = "let x: number = \"hello\";";
console.log("");
console.log("Test 2: " + source2);

let ast2 = parseSource(source2);
if (ast2 == null) {
    console.log("  FAIL: Parse failed");
} else {
    console.log("  Parsed successfully");
    let result2 = Passes.structuralTypeCheck(ast2);
    console.log("  Type check complete, " + result2.errors.length + " errors");
    if (result2.errors.length > 0) {
        console.log("  PASS: Got expected type error:");
        console.log("    " + result2.errors[0].message);
    } else {
        console.log("  FAIL: Expected type error but got none");
    }
}

// Test 3: Interface structural typing
let source3 = "interface Point { x: number; y: number; } let p: Point = { x: 10, y: 20 };";
console.log("");
console.log("Test 3: Interface structural typing");

let ast3 = parseSource(source3);
if (ast3 == null) {
    console.log("  FAIL: Parse failed");
} else {
    console.log("  Parsed successfully");
    let result3 = Passes.structuralTypeCheck(ast3);
    console.log("  Type check complete, " + result3.errors.length + " errors");
    if (result3.errors.length == 0) {
        console.log("  PASS: Object matches interface");
    } else {
        console.log("  FAIL: Unexpected errors:");
        let i = 0;
        while (i < result3.errors.length) {
            console.log("    " + result3.errors[i].message);
            i = i + 1;
        }
    }
}

// Test 4: Missing field should error
let source4 = "interface Point { x: number; y: number; } let p: Point = { x: 10 };";
console.log("");
console.log("Test 4: Missing required field");

let ast4 = parseSource(source4);
if (ast4 == null) {
    console.log("  FAIL: Parse failed");
} else {
    console.log("  Parsed successfully");
    let result4 = Passes.structuralTypeCheck(ast4);
    console.log("  Type check complete, " + result4.errors.length + " errors");
    if (result4.errors.length > 0) {
        console.log("  PASS: Got expected type error:");
        console.log("    " + result4.errors[0].message);
    } else {
        console.log("  FAIL: Expected type error but got none");
    }
}

// Test 5: Extra fields allowed (width subtyping)
let source5 = "interface Point { x: number; y: number; } let p: Point = { x: 10, y: 20, z: 30 };";
console.log("");
console.log("Test 5: Extra fields allowed (width subtyping)");

let ast5 = parseSource(source5);
if (ast5 == null) {
    console.log("  FAIL: Parse failed");
} else {
    console.log("  Parsed successfully");
    let result5 = Passes.structuralTypeCheck(ast5);
    console.log("  Type check complete, " + result5.errors.length + " errors");
    if (result5.errors.length == 0) {
        console.log("  PASS: Extra fields allowed");
    } else {
        console.log("  FAIL: Unexpected errors");
    }
}

console.log("");
console.log("Tests complete!");
