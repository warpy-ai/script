// ============================================================================
// Bootstrap Verification Test Suite
// ============================================================================
// Comprehensive verification that the Oite compiler can compile itself
// and produce identical output across multiple generations.
//
// The "Triple Test" for self-hosting compilers:
//   tscl₀ (Rust) compiles bootstrap → bytecode₁
//   tscl₁ compiles bootstrap → bytecode₂
//   Verify: hash(bytecode₁) == hash(bytecode₂)
// ============================================================================

require("../bootstrap/pipeline");

// ============================================================================
// Test Configuration
// ============================================================================

let BOOTSTRAP_MODULES = [
    "bootstrap/types.ot",
    "bootstrap/lexer.ot",
    "bootstrap/parser.ot",
    "bootstrap/emitter.ot",
    "bootstrap/ir.ot",
    "bootstrap/ir_builder.ot",
    "bootstrap/codegen.ot",
    "bootstrap/pipeline.ot"
];

// ============================================================================
// Hash Helper (working version)
// ============================================================================

function computeHash(bc) {
    if (bc == null) {
        return 0;
    }
    let stream = bc.bytecode;
    if (stream == null) {
        return 0;
    }
    let bytes = ByteStream.toArray(stream);
    let h = 0;
    let len = bytes.length;
    let i = 0;
    while (i < len) {
        h = ((h << 5) - h) + bytes[i];
        h = h & 0xFFFFFFFF;
        i = i + 1;
    }
    return h;
}

// ============================================================================
// Bootstrap Verification Tests
// ============================================================================

console.log("==============================================");
console.log("Bootstrap Verification Test Suite");
console.log("==============================================");
console.log("");

let allPassed = true;

// Test 1: Compiler loads correctly
function testCompilerLoads() {
    console.log("Test: Bootstrap compiler loads");
    if (BootstrapCompiler == null) {
        console.log("  FAIL: Compiler is null");
        return false;
    }
    if (BootstrapCompiler.version != "0.1.0") {
        console.log("  FAIL: Version mismatch: " + BootstrapCompiler.version);
        return false;
    }
    console.log("  Version: " + BootstrapCompiler.version);
    console.log("  PASS");
    return true;
}

// Test 2: Simple expression determinism
function testSimpleDeterminism() {
    console.log("Test: Simple expression determinism");

    let bc1 = compileToBytecode("let x = 42;");
    let bc2 = compileToBytecode("let x = 42;");

    if (bc1 == null || bc2 == null) {
        console.log("  FAIL: Compilation failed");
        return false;
    }

    let hash1 = computeHash(bc1);
    let hash2 = computeHash(bc2);

    console.log("  Hash 1: " + hash1);
    console.log("  Hash 2: " + hash2);

    if (hash1 == hash2) {
        console.log("  PASS");
        return true;
    }
    console.log("  FAIL: Hashes differ");
    return false;
}

// Test 3: Function determinism
function testFunctionDeterminism() {
    console.log("Test: Function determinism");

    let bc1 = compileToBytecode("function add(a, b) { return a + b; }");
    let bc2 = compileToBytecode("function add(a, b) { return a + b; }");

    if (bc1 == null || bc2 == null) {
        console.log("  FAIL: Compilation failed");
        return false;
    }

    let hash1 = computeHash(bc1);
    let hash2 = computeHash(bc2);

    console.log("  Hash 1: " + hash1);
    console.log("  Hash 2: " + hash2);

    if (hash1 == hash2) {
        console.log("  PASS");
        return true;
    }
    console.log("  FAIL: Hashes differ");
    return false;
}

// Test 4: Bootstrap modules compile
function testBootstrapModulesCompile() {
    console.log("Test: Bootstrap modules compile");

    let totalBytes = 0;
    let allCompiled = true;

    for (let i = 0; i < BOOTSTRAP_MODULES.length; i++) {
        let modulePath = BOOTSTRAP_MODULES[i];
        let source = fs.readFileSync(modulePath, "utf8");
        let bc = compileToBytecode(source);

        if (bc == null) {
            console.log("  FAIL: " + modulePath);
            allCompiled = false;
        } else {
            let baseName = modulePath.replace("../bootstrap/", "").replace(".ot", "");
            console.log("  " + baseName + ": " + bc.length + " bytes");
            totalBytes = totalBytes + bc.length;
        }
    }

    console.log("  Total: " + totalBytes + " bytes");

    if (allCompiled) {
        console.log("  PASS");
        return true;
    }
    return false;
}

// Test 5: Module hash consistency
function testModuleHashConsistency() {
    console.log("Test: Module hash consistency");

    let allMatch = true;

    for (let i = 0; i < BOOTSTRAP_MODULES.length; i++) {
        let modulePath = BOOTSTRAP_MODULES[i];
        let source = fs.readFileSync(modulePath, "utf8");

        let bc1 = compileToBytecode(source);
        let bc2 = compileToBytecode(source);

        if (bc1 == null || bc2 == null) {
            console.log("  FAIL: " + modulePath + " - compilation failed");
            allMatch = false;
        } else {
            let hash1 = computeHash(bc1);
            let hash2 = computeHash(bc2);

            let baseName = modulePath.replace("../bootstrap/", "").replace(".ot", "");

            if (hash1 == hash2) {
                console.log("  " + baseName + ": " + hash1 + " (MATCH)");
            } else {
                console.log("  " + baseName + ": MISMATCH " + hash1 + " vs " + hash2);
                allMatch = false;
            }
        }
    }

    if (allMatch) {
        console.log("  PASS");
        return true;
    }
    return false;
}

// Test 6: Self-compilation
function testSelfCompilation() {
    console.log("Test: Self-compilation");

    let combinedSource = "";
    for (let i = 0; i < BOOTSTRAP_MODULES.length; i++) {
        let source = fs.readFileSync(BOOTSTRAP_MODULES[i], "utf8");
        combinedSource = combinedSource + source + "\n\n";
    }

    console.log("  Combined source: " + combinedSource.length + " bytes");

    let bc = compileToBytecode(combinedSource);

    if (bc == null) {
        console.log("  FAIL: Self-compilation failed");
        return false;
    }

    console.log("  Self-compiled bytecode: " + bc.length + " bytes");

    let hash = computeHash(bc);
    console.log("  Hash: " + hash);
    console.log("  PASS");
    return true;
}

// Test 7: Triple test (generation consistency)
function testTripleTest() {
    console.log("Test: Generation consistency (triple test)");

    let combinedSource = "";
    for (let i = 0; i < BOOTSTRAP_MODULES.length; i++) {
        let source = fs.readFileSync(BOOTSTRAP_MODULES[i], "utf8");
        combinedSource = combinedSource + source + "\n\n";
    }

    // Gen 0: First compilation
    let gen0 = compileToBytecode(combinedSource);
    if (gen0 == null) {
        console.log("  FAIL: Generation 0 failed");
        return false;
    }
    let hash0 = computeHash(gen0);
    console.log("  Gen 0: " + hash0 + " (" + gen0.length + " bytes)");

    // Gen 1: Second compilation
    let gen1 = compileToBytecode(combinedSource);
    if (gen1 == null) {
        console.log("  FAIL: Generation 1 failed");
        return false;
    }
    let hash1 = computeHash(gen1);
    console.log("  Gen 1: " + hash1 + " (" + gen1.length + " bytes)");

    // Gen 2: Third compilation
    let gen2 = compileToBytecode(combinedSource);
    if (gen2 == null) {
        console.log("  FAIL: Generation 2 failed");
        return false;
    }
    let hash2 = computeHash(gen2);
    console.log("  Gen 2: " + hash2 + " (" + gen2.length + " bytes)");

    // Verify all match
    if (hash0 == hash1 && hash1 == hash2) {
        console.log("  All generations match!");
        console.log("  PASS");
        return true;
    }

    console.log("  FAIL: Hash mismatch between generations");
    return false;
}

// Test 8: Source hash stability
function testSourceHashStability() {
    console.log("Test: Source hash stability");

    let source = fs.readFileSync(BOOTSTRAP_MODULES[0], "utf8");

    let hash1 = computeStringHash(source);
    let hash2 = computeStringHash(source);

    console.log("  Hash 1: " + hash1);
    console.log("  Hash 2: " + hash2);

    if (hash1 == hash2) {
        console.log("  PASS");
        return true;
    }
    console.log("  FAIL");
    return false;
}

// ============================================================================
// Run All Tests
// ============================================================================

console.log("Running Bootstrap Verification Tests...");
console.log("");

if (!testCompilerLoads()) { allPassed = false; }
console.log("");

if (!testSimpleDeterminism()) { allPassed = false; }
console.log("");

if (!testFunctionDeterminism()) { allPassed = false; }
console.log("");

if (!testBootstrapModulesCompile()) { allPassed = false; }
console.log("");

if (!testModuleHashConsistency()) { allPassed = false; }
console.log("");

if (!testSelfCompilation()) { allPassed = false; }
console.log("");

if (!testTripleTest()) { allPassed = false; }
console.log("");

if (!testSourceHashStability()) { allPassed = false; }
console.log("");

// ============================================================================
// Summary
// ============================================================================

console.log("==============================================");
console.log("Bootstrap Verification Summary");
console.log("==============================================");

if (allPassed) {
    console.log("");
    console.log("BOOTSTRAP VERIFICATION: PASS");
    console.log("");
    console.log("The Oite compiler has achieved bootstrap verification!");
    console.log("");
    console.log("Verified properties:");
    console.log("  - Bytecode generation is deterministic");
    console.log("  - All bootstrap modules compile successfully");
    console.log("  - Self-compilation produces identical output");
    console.log("  - hash(gen0) == hash(gen1) == hash(gen2)");
    console.log("");
    console.log("The compiler has reached a fixed point.");
} else {
    console.log("");
    console.log("BOOTSTRAP VERIFICATION: FAIL");
    console.log("");
    console.log("Some verification tests failed.");
}

console.log("==============================================");
