// ============================================================================
// Pipeline Test Suite
// ============================================================================

require("../../bootstrap/pipeline");

let BOOTSTRAP_MODULES = [
    "bootstrap/types.ot",
    "bootstrap/lexer.ot",
    "bootstrap/parser.ot",
    "bootstrap/emitter.ot",
    "bootstrap/ir.ot",
    "bootstrap/ir_builder.ot",
    "bootstrap/codegen.ot",
    "bootstrap/pipeline.ot"
];

console.log("==============================================");
console.log("Pipeline Test Suite");
console.log("==============================================");
console.log("");

let allPassed = true;

function testSimpleExpression() {
    console.log("Test: Simple Expression");
    
    let result = compileToBytecode("1 + 2 * 3");
    
    if (result == null || result.length <= 0) {
        console.log("FAIL: Compilation failed");
        return false;
    }
    
    console.log("  PASS: Simple expression compiles");
    console.log("    Bytecode: " + result.length + " bytes");
    return true;
}

function testVariableDeclaration() {
    console.log("Test: Variable Declaration");
    
    let result = compileToBytecode("let x = 42;");
    
    if (result == null) {
        console.log("FAIL: Compilation failed");
        return false;
    }
    
    console.log("  PASS: Variable declaration compiles");
    console.log("    Bytecode: " + result.length + " bytes");
    return true;
}

function testFunctionDeclaration() {
    console.log("Test: Function Declaration");
    
    let result = compileToBytecode("function add(a, b) { return a + b; }");
    
    if (result == null) {
        console.log("FAIL: Compilation failed");
        return false;
    }
    
    console.log("  PASS: Function declaration compiles");
    console.log("    Bytecode: " + result.length + " bytes");
    return true;
}

function testFullPipeline() {
    console.log("Test: Full Pipeline Metrics");
    
    let metrics = measureCompilation("let x = 1; let y = 2; x + y;");
    
    if (metrics == null) {
        console.log("FAIL: Metrics failed");
        return false;
    }
    
    console.log("  PASS: Full pipeline metrics collected");
    console.log("    Lexer: " + metrics.lexerTime + "ms");
    console.log("    Parser: " + metrics.parserTime + "ms");
    console.log("    IR: " + metrics.irTime + "ms");
    console.log("    Codegen: " + metrics.codegenTime + "ms");
    console.log("    Total: " + metrics.totalTime + "ms");
    console.log("    Bytecode: " + metrics.bytecodeSize + " bytes");
    return true;
}

function testModuleCompilation() {
    console.log("Test: Module Compilation");
    
    let source = "function isPrime(n) { if (n <= 1) { return false; } if (n <= 3) { return true; } return true; }";
    let result = compileModule(source);
    
    if (result == null) {
        console.log("FAIL: Module compilation failed");
        return false;
    }
    
    console.log("  PASS: Module compiles successfully");
    console.log("    Bytecode: " + result.length + " bytes");
    return true;
}

function testBootstrapCompilerVersion() {
    console.log("Test: Bootstrap Compiler Version");
    
    if (BootstrapCompiler.version != "0.1.0") {
        console.log("FAIL: Version mismatch");
        return false;
    }
    
    console.log("  PASS: Bootstrap compiler version correct");
    console.log("    Version: " + BootstrapCompiler.version);
    console.log("    Pipeline: " + BootstrapCompiler.pipeline);
    return true;
}

function runAllPipelineTests() {
    console.log("Running Pipeline Tests...\n");
    
    if (!testSimpleExpression()) { allPassed = false; }
    console.log("");
    
    if (!testVariableDeclaration()) { allPassed = false; }
    console.log("");
    
    if (!testFunctionDeclaration()) { allPassed = false; }
    console.log("");
    
    if (!testFullPipeline()) { allPassed = false; }
    console.log("");
    
    if (!testModuleCompilation()) { allPassed = false; }
    console.log("");
    
    if (!testBootstrapCompilerVersion()) { allPassed = false; }
    console.log("");
    
    console.log("==============================================");
    if (allPassed) {
        console.log("All Pipeline tests passed!");
    } else {
        console.log("Some Pipeline tests failed!");
    }
    console.log("==============================================");
}

runAllPipelineTests();

console.log("");
console.log("==============================================");
console.log("Self-Hosting Bootstrap Tests");
console.log("==============================================");
console.log("");

function testBootstrapLoads() {
    console.log("Test: Bootstrap compiler loads");
    if (BootstrapCompiler == null) {
        console.log("  FAIL");
        return false;
    }
    if (BootstrapCompiler.version != "0.1.0") {
        console.log("  FAIL");
        return false;
    }
    console.log("  PASS");
    return true;
}

function testPipelineSimple() {
    console.log("Test: Pipeline compiles simple expression");
    let result = compileToBytecode("let x = 1 + 2;");
    if (result == null) {
        console.log("  FAIL");
        return false;
    }
    console.log("  PASS");
    return true;
}

function testPipelineFunction() {
    console.log("Test: Pipeline compiles function");
    let result = compileToBytecode("function add(a, b) { return a + b; }");
    if (result == null) {
        console.log("  FAIL");
        return false;
    }
    console.log("  PASS");
    return true;
}

function testBootstrapModulesCompile() {
    console.log("Test: Bootstrap modules can be compiled");
    let allCompiled = true;
    let i = 0;
    while (i < BOOTSTRAP_MODULES.length) {
        let source = fs.readFileSync(BOOTSTRAP_MODULES[i], "utf8");
        let result = compileToBytecode(source);
        if (result == null) {
            console.log("  FAIL: Could not compile " + BOOTSTRAP_MODULES[i]);
            allCompiled = false;
        }
        i = i + 1;
    }
    if (allCompiled) {
        console.log("  PASS: All " + BOOTSTRAP_MODULES.length + " modules compiled successfully");
    }
    return allCompiled;
}

function testSelfCompilation() {
    console.log("Test: Self-compilation produces bytecode");
    let allSource = "";
    let i = 0;
    while (i < BOOTSTRAP_MODULES.length) {
        let source = fs.readFileSync(BOOTSTRAP_MODULES[i], "utf8");
        allSource = allSource + source + "\n\n";
        i = i + 1;
    }
    let result = compileToBytecode(allSource);
    if (result == null) {
        console.log("  FAIL");
        return false;
    }
    console.log("  PASS: Self-compilation produced " + result.length + " bytes");
    return true;
}

let loopPassed = true;
if (!testBootstrapLoads()) { loopPassed = false; }
console.log("");
if (!testPipelineSimple()) { loopPassed = false; }
console.log("");
if (!testPipelineFunction()) { loopPassed = false; }
console.log("");
if (!testBootstrapModulesCompile()) { loopPassed = false; }
console.log("");
if (!testSelfCompilation()) { loopPassed = false; }
console.log("");

console.log("==============================================");
if (loopPassed) {
    console.log("All Self-Hosting tests passed!");
} else {
    console.log("Some Self-Hosting tests failed!");
}
console.log("==============================================");

console.log("");
console.log("==============================================");
console.log("Bootstrap Loop Verification");
console.log("==============================================");
console.log("");

function testModuleBytecodeSerialization() {
    console.log("Test: Serialize module bytecode (verification)");
    let passed = true;
    let i = 0;
    while (i < BOOTSTRAP_MODULES.length) {
        let source = fs.readFileSync(BOOTSTRAP_MODULES[i], "utf8");
        let bytecode = compileToBytecode(source);
        if (bytecode == null) {
            console.log("  FAIL: " + BOOTSTRAP_MODULES[i]);
            passed = false;
        }
        i = i + 1;
    }
    if (passed) {
        console.log("  PASS: All modules produce valid bytecode");
    }
    return passed;
}

function testBootstrapLoop() {
    console.log("==============================================");
    console.log("Bootstrap Loop Verification");
    console.log("==============================================");
    console.log("");

    let allPassed = true;
    let i = 0;
    while (i < BOOTSTRAP_MODULES.length) {
        let modulePath = BOOTSTRAP_MODULES[i];
        let source = fs.readFileSync(modulePath, "utf8");
        let bytecodeA = compileToBytecode(source);
        let bytecodeB = compileToBytecode(source);

        if (bytecodeA == null || bytecodeB == null) {
            console.log("  FAIL: " + modulePath + " - compilation failed");
            allPassed = false;
        } else if (bytecodeA.length != bytecodeB.length) {
            console.log("  FAIL: " + modulePath + " - non-deterministic output");
            allPassed = false;
        } else {
            let baseName = modulePath.replace("bootstrap/", "").replace(".ot", "");
            console.log("  " + baseName + ": " + bytecodeA.length + " bytes (deterministic)");
        }
        i = i + 1;
    }

    console.log("");
    console.log("==============================================");
    if (allPassed) {
        console.log("Bootstrap Loop: PASS");
    } else {
        console.log("Bootstrap Loop: FAIL");
    }
    console.log("==============================================");
    return allPassed;
}

function testHashVerification() {
    console.log("");
    console.log("==============================================");
    console.log("Hash Verification Tests");
    console.log("==============================================");
    console.log("");

    let allPassed = true;

    console.log("Test: Compute source string hash");
    let testStr = "Hello, Bootstrap!";
    let hash1 = computeStringHash(testStr);
    let hash2 = computeStringHash(testStr);
    if (hash1 == hash2 && hash1 != 0) {
        console.log("  Hash: " + hash1.toString(16));
        console.log("  PASS: Consistent hash computation");
    } else {
        console.log("  FAIL: Hash mismatch (hash1=" + hash1 + ", hash2=" + hash2 + ")");
        allPassed = false;
    }

    console.log("");
    console.log("Test: Compile and compute bytecode hash");
    let bytecode = compileToBytecode("let x = 42;");
    if (bytecode == null) {
        console.log("  FAIL: Could not compile");
        allPassed = false;
    } else {
        let byteHash = computeBytecodeHash(bytecode);
        console.log("  Bytecode length: " + bytecode.length);
        if (byteHash != null && byteHash != 0) {
            console.log("  Bytecode hash: " + byteHash.toString(16));
            console.log("  PASS");
        } else {
            console.log("  FAIL: Hash computation returned invalid value");
            allPassed = false;
        }
    }

    console.log("");
    console.log("==============================================");
    if (allPassed) {
        console.log("Hash Verification: PASS");
    } else {
        console.log("Hash Verification: FAIL");
    }
    console.log("==============================================");

    return allPassed;
}

function testFullBootstrap() {
    console.log("");
    console.log("==============================================");
    console.log("Full Bootstrap Compilation Test");
    console.log("==============================================");
    console.log("");

    let totalSource = 0;
    let totalBytecode = 0;

    console.log("Compiling all bootstrap modules...");
    console.log("");

    let i = 0;
    while (i < BOOTSTRAP_MODULES.length) {
        let modulePath = BOOTSTRAP_MODULES[i];
        let source = fs.readFileSync(modulePath, "utf8");
        totalSource = totalSource + source.length;

        let bytecode = compileToBytecode(source);
        if (bytecode == null) {
            console.log("FAIL: Could not compile " + modulePath);
            return false;
        }

        totalBytecode = totalBytecode + bytecode.length;

        let baseName = modulePath.replace("bootstrap/", "").replace(".ot", "");
        console.log("  " + baseName + ": " + source.length + " bytes -> " + bytecode.length + " bytes");
        i = i + 1;
    }

    console.log("");
    console.log("Total: " + totalSource + " source bytes -> " + totalBytecode + " bytecode bytes");

    let combinedSource = "";
    let j = 0;
    while (j < BOOTSTRAP_MODULES.length) {
        combinedSource = combinedSource + fs.readFileSync(BOOTSTRAP_MODULES[j], "utf8") + "\n\n";
        j = j + 1;
    }

    let combinedBytecode = compileToBytecode(combinedSource);
    if (combinedBytecode == null) {
        console.log("FAIL: Self-compilation failed");
        return false;
    }

    console.log("Combined: " + combinedSource.length + " bytes -> " + combinedBytecode.length + " bytes");
    console.log("");
    console.log("==============================================");
    console.log("Full Bootstrap: PASS");
    console.log("==============================================");

    return true;
}

let loopResult = testBootstrapLoop();
let hashResult = testHashVerification();
let fullResult = testFullBootstrap();

console.log("");
console.log("==============================================");
console.log("Hash Match Verification Test");
console.log("==============================================");
console.log("");

console.log("Verifying that multiple compilations produce identical bytecode...");

function testHashMatchVerification() {
    let hashMatchPassed = true;

    console.log("Testing individual modules...");
    let i = 0;
    while (i < BOOTSTRAP_MODULES.length) {
        let modulePath = BOOTSTRAP_MODULES[i];
        let source = fs.readFileSync(modulePath, "utf8");

        let bcA = compileToBytecode(source);
        let lenA = bcA.length;
        let hA = computeBytecodeHash(bcA);

        let bcB = compileToBytecode(source);
        let lenB = bcB.length;
        let hB = computeBytecodeHash(bcB);

        let hashesMatch = hA == hB;
        let lensMatch = lenA == lenB;

        if (hashesMatch && lensMatch) {
            let baseName = modulePath.replace("bootstrap/", "").replace(".ot", "");
            console.log("  " + baseName + ": MATCH");
        } else {
            let baseName = modulePath.replace("bootstrap/", "").replace(".ot", "");
            console.log("  " + baseName + ": MISMATCH");
            hashMatchPassed = false;
        }
        i = i + 1;
    }

    console.log("Testing combined source...");
    let combinedSource = "";
    let moduleCount = 0;
    let j = 0;
    while (j < BOOTSTRAP_MODULES.length) {
        combinedSource = combinedSource + fs.readFileSync(BOOTSTRAP_MODULES[j], "utf8") + "\n\n";
        moduleCount = j + 1;
        j = j + 1;
    }

    let scA = compileToBytecode(combinedSource);
    let slenA = scA.length;
    let shA = computeBytecodeHash(scA);

    let scB = compileToBytecode(combinedSource);
    let slenB = scB.length;
    let shB = computeBytecodeHash(scB);

    let combinedMatch = shA == shB && slenA == slenB;
    console.log("  Combined (" + moduleCount + " modules): " + (combinedMatch ? "MATCH" : "MISMATCH"));

    if (!combinedMatch) {
        hashMatchPassed = false;
    }

    console.log("");
    console.log("==============================================");
    if (hashMatchPassed) {
        console.log("Hash Match Verification: PASS");
        console.log("");
        console.log("The bootstrap compiler is DETERMINISTIC!");
    } else {
        console.log("Hash Match Verification: FAIL");
    }
    console.log("==============================================");

    return hashMatchPassed;
}

let hashMatchResult = testHashMatchVerification();

console.log("");
console.log("==============================================");
console.log("Summary");
console.log("==============================================");
console.log("Bootstrap Loop: " + (loopResult ? "PASS" : "FAIL"));
console.log("Hash Verification: " + (hashResult ? "PASS" : "FAIL"));
console.log("Full Bootstrap: " + (fullResult ? "PASS" : "FAIL"));
console.log("Hash Match: " + (hashMatchResult ? "PASS" : "FAIL"));
console.log("==============================================");
