// ============================================================================
// Pipeline Test Suite
// ============================================================================

require("../bootstrap/pipeline");

let BOOTSTRAP_MODULES = [
    "../bootstrap/types.tscl",
    "../bootstrap/lexer.tscl",
    "../bootstrap/parser.tscl",
    "../bootstrap/emitter.tscl",
    "../bootstrap/ir.tscl",
    "../bootstrap/ir_builder.tscl",
    "../bootstrap/codegen.tscl",
    "../bootstrap/pipeline.tscl"
];

console.log("==============================================");
console.log("Pipeline Test Suite");
console.log("==============================================");
console.log("");

let allPassed = true;

function testSimpleExpression() {
    console.log("Test: Simple Expression");
    
    let result = compileToBytecode("1 + 2 * 3");
    
    if (result == null || result.length <= 0) {
        console.log("FAIL: Compilation failed");
        return false;
    }
    
    console.log("  PASS: Simple expression compiles");
    console.log("    Bytecode: " + result.length + " bytes");
    return true;
}

function testVariableDeclaration() {
    console.log("Test: Variable Declaration");
    
    let result = compileToBytecode("let x = 42;");
    
    if (result == null) {
        console.log("FAIL: Compilation failed");
        return false;
    }
    
    console.log("  PASS: Variable declaration compiles");
    console.log("    Bytecode: " + result.length + " bytes");
    return true;
}

function testFunctionDeclaration() {
    console.log("Test: Function Declaration");
    
    let result = compileToBytecode("function add(a, b) { return a + b; }");
    
    if (result == null) {
        console.log("FAIL: Compilation failed");
        return false;
    }
    
    console.log("  PASS: Function declaration compiles");
    console.log("    Bytecode: " + result.length + " bytes");
    return true;
}

function testFullPipeline() {
    console.log("Test: Full Pipeline Metrics");
    
    let metrics = measureCompilation("let x = 1; let y = 2; x + y;");
    
    if (metrics == null) {
        console.log("FAIL: Metrics failed");
        return false;
    }
    
    console.log("  PASS: Full pipeline metrics collected");
    console.log("    Lexer: " + metrics.lexerTime + "ms");
    console.log("    Parser: " + metrics.parserTime + "ms");
    console.log("    IR: " + metrics.irTime + "ms");
    console.log("    Codegen: " + metrics.codegenTime + "ms");
    console.log("    Total: " + metrics.totalTime + "ms");
    console.log("    Bytecode: " + metrics.bytecodeSize + " bytes");
    return true;
}

function testModuleCompilation() {
    console.log("Test: Module Compilation");
    
    let source = "function isPrime(n) { if (n <= 1) { return false; } if (n <= 3) { return true; } return true; }";
    let result = compileModule(source);
    
    if (result == null) {
        console.log("FAIL: Module compilation failed");
        return false;
    }
    
    console.log("  PASS: Module compiles successfully");
    console.log("    Bytecode: " + result.length + " bytes");
    return true;
}

function testBootstrapCompilerVersion() {
    console.log("Test: Bootstrap Compiler Version");
    
    if (BootstrapCompiler.version != "0.1.0") {
        console.log("FAIL: Version mismatch");
        return false;
    }
    
    console.log("  PASS: Bootstrap compiler version correct");
    console.log("    Version: " + BootstrapCompiler.version);
    console.log("    Pipeline: " + BootstrapCompiler.pipeline);
    return true;
}

function runAllPipelineTests() {
    console.log("Running Pipeline Tests...\n");
    
    if (!testSimpleExpression()) { allPassed = false; }
    console.log("");
    
    if (!testVariableDeclaration()) { allPassed = false; }
    console.log("");
    
    if (!testFunctionDeclaration()) { allPassed = false; }
    console.log("");
    
    if (!testFullPipeline()) { allPassed = false; }
    console.log("");
    
    if (!testModuleCompilation()) { allPassed = false; }
    console.log("");
    
    if (!testBootstrapCompilerVersion()) { allPassed = false; }
    console.log("");
    
    console.log("==============================================");
    if (allPassed) {
        console.log("All Pipeline tests passed!");
    } else {
        console.log("Some Pipeline tests failed!");
    }
    console.log("==============================================");
}

runAllPipelineTests();

console.log("");
console.log("==============================================");
console.log("Self-Hosting Bootstrap Tests");
console.log("==============================================");
console.log("");

function testBootstrapLoads() {
    console.log("Test: Bootstrap compiler loads");
    if (BootstrapCompiler == null) {
        console.log("  FAIL");
        return false;
    }
    if (BootstrapCompiler.version != "0.1.0") {
        console.log("  FAIL");
        return false;
    }
    console.log("  PASS");
    return true;
}

function testPipelineSimple() {
    console.log("Test: Pipeline compiles simple expression");
    let result = compileToBytecode("let x = 1 + 2;");
    if (result == null) {
        console.log("  FAIL");
        return false;
    }
    console.log("  PASS");
    return true;
}

function testPipelineFunction() {
    console.log("Test: Pipeline compiles function");
    let result = compileToBytecode("function add(a, b) { return a + b; }");
    if (result == null) {
        console.log("  FAIL");
        return false;
    }
    console.log("  PASS");
    return true;
}

function testBootstrapModulesCompile() {
    console.log("Test: Bootstrap modules can be compiled");
    let allCompiled = true;
    for (let i = 0; i < BOOTSTRAP_MODULES.length; i++) {
        let source = fs.readFileSync(BOOTSTRAP_MODULES[i], "utf8");
        let result = compileToBytecode(source);
        if (result == null) {
            console.log("  FAIL: Could not compile " + BOOTSTRAP_MODULES[i]);
            allCompiled = false;
        }
    }
    if (allCompiled) {
        console.log("  PASS: All " + BOOTSTRAP_MODULES.length + " modules compiled successfully");
    }
    return allCompiled;
}

function testSelfCompilation() {
    console.log("Test: Self-compilation produces bytecode");
    let allSource = "";
    for (let i = 0; i < BOOTSTRAP_MODULES.length; i++) {
        let source = fs.readFileSync(BOOTSTRAP_MODULES[i], "utf8");
        allSource = allSource + source + "\n\n";
    }
    let result = compileToBytecode(allSource);
    if (result == null) {
        console.log("  FAIL");
        return false;
    }
    console.log("  PASS: Self-compilation produced " + result.length + " bytes");
    return true;
}

let loopPassed = true;
if (!testBootstrapLoads()) { loopPassed = false; }
console.log("");
if (!testPipelineSimple()) { loopPassed = false; }
console.log("");
if (!testPipelineFunction()) { loopPassed = false; }
console.log("");
if (!testBootstrapModulesCompile()) { loopPassed = false; }
console.log("");
if (!testSelfCompilation()) { loopPassed = false; }
console.log("");

console.log("==============================================");
if (loopPassed) {
    console.log("All Self-Hosting tests passed!");
} else {
    console.log("Some Self-Hosting tests failed!");
}
console.log("==============================================");

console.log("");
console.log("==============================================");
console.log("Bootstrap Loop Verification");
console.log("==============================================");
console.log("");

function testModuleBytecodeSerialization() {
    console.log("Test: Serialize module bytecode (verification)");
    console.log("");

    let outputDir = "/tmp/tscl_bootstrap_bytecode";
    if (!fs.existsSync(outputDir)) {
        fs.mkdirSync(outputDir, { recursive: true });
    }

    let totalBytes = 0;
    for (let i = 0; i < BOOTSTRAP_MODULES.length; i++) {
        let modulePath = BOOTSTRAP_MODULES[i];
        let bytecode = compileFile(modulePath);

        if (bytecode == null) {
            console.log("  FAIL: Could not compile " + modulePath);
            return false;
        }

        let baseName = modulePath.replace("../bootstrap/", "").replace(".tscl", "");
        let outputPath = outputDir + "/" + baseName + ".bc";

        let bytesWritten = saveBytecode(outputPath, bytecode);

        totalBytes = totalBytes + bytesWritten;
        console.log("  " + baseName + ": " + bytecode.length + " bytes written");
    }

    console.log("");
    console.log("Total: " + totalBytes + " bytes");
    console.log("  PASS: Serialization verified");
    return true;
}

function testBootstrapLoop() {
    console.log("==============================================");
    console.log("Bootstrap Loop Verification");
    console.log("==============================================");
    console.log("");

    console.log("This test verifies that the bootstrap compiler can:");
    console.log("1. Compile all 8 bootstrap modules to bytecode");
    console.log("2. Self-compile (compile all modules together)");
    console.log("");

    let loopPassed = true;

    console.log("--- Step 1: Individual Module Compilation ---");
    let step1Passed = true;
    for (let i = 0; i < BOOTSTRAP_MODULES.length; i++) {
        let bytecode = compileFile(BOOTSTRAP_MODULES[i]);
        if (bytecode == null) {
            step1Passed = false;
        }
    }
    if (step1Passed) {
        console.log("  PASS: All modules compiled");
    } else {
        console.log("  FAIL: Some modules failed");
        loopPassed = false;
    }
    console.log("");

    console.log("--- Step 2: Self-Compilation ---");
    let allSource = "";
    for (let i = 0; i < BOOTSTRAP_MODULES.length; i++) {
        let source = fs.readFileSync(BOOTSTRAP_MODULES[i], "utf8");
        allSource = allSource + source + "\n\n";
    }
    let selfBytecode = compileToBytecode(allSource);
    if (selfBytecode != null) {
        console.log("  PASS: Self-compilation produced " + selfBytecode.length + " bytes");
    } else {
        console.log("  FAIL: Self-compilation failed");
        loopPassed = false;
    }
    console.log("");

    console.log("--- Step 3: Bytecode Serialization ---");
    if (!testModuleBytecodeSerialization()) {
        loopPassed = false;
    }
    console.log("");

    console.log("==============================================");
    if (loopPassed) {
        console.log("Bootstrap Loop: PASS");
    } else {
        console.log("Bootstrap Loop: FAIL");
    }
    console.log("==============================================");

    return loopPassed;
}

function testHashVerification() {
    console.log("");
    console.log("==============================================");
    console.log("Hash Verification Tests");
    console.log("==============================================");
    console.log("");

    let allPassed = true;

    console.log("Test: Compute source string hash");
    let testStr = "Hello, Bootstrap!";
    let hash1 = computeStringHash(testStr);
    let hash2 = computeStringHash(testStr);
    if (hash1 == hash2 && hash1 != 0) {
        console.log("  Hash: " + hash1.toString(16));
        console.log("  PASS: Consistent hash computation");
    } else {
        console.log("  FAIL: Hash mismatch (hash1=" + hash1 + ", hash2=" + hash2 + ")");
        allPassed = false;
    }

    console.log("");
    console.log("Test: Compile and compute bytecode hash");
    let bytecode = compileToBytecode("let x = 42;");
    if (bytecode == null) {
        console.log("  FAIL: Could not compile");
        allPassed = false;
    } else {
        let byteHash = computeBytecodeHash(bytecode);
        console.log("  Bytecode length: " + bytecode.length);
        if (byteHash != null && byteHash != 0) {
            console.log("  Bytecode hash: " + byteHash.toString(16));
            console.log("  PASS");
        } else {
            console.log("  FAIL: Hash computation returned invalid value");
            allPassed = false;
        }
    }

    console.log("");
    console.log("==============================================");
    if (allPassed) {
        console.log("Hash Verification: PASS");
    } else {
        console.log("Hash Verification: FAIL");
    }
    console.log("==============================================");

    return allPassed;
}

function testFullBootstrap() {
    console.log("");
    console.log("==============================================");
    console.log("Full Bootstrap Compilation Test");
    console.log("==============================================");
    console.log("");

    let outputDir = "/tmp/tscl_bootstrap_output";
    if (!fs.existsSync(outputDir)) {
        fs.mkdirSync(outputDir, { recursive: true });
    }

    let totalSource = 0;
    let totalBytecode = 0;

    console.log("Compiling all bootstrap modules...");
    console.log("");

    for (let i = 0; i < BOOTSTRAP_MODULES.length; i++) {
        let modulePath = BOOTSTRAP_MODULES[i];
        let source = fs.readFileSync(modulePath, "utf8");
        totalSource = totalSource + source.length;

        let bytecode = compileToBytecode(source);
        if (bytecode == null) {
            console.log("FAIL: Could not compile " + modulePath);
            return false;
        }

        totalBytecode = totalBytecode + bytecode.length;

        let baseName = modulePath.replace("../bootstrap/", "").replace(".tscl", "");
        let outputPath = outputDir + "/" + baseName + ".bc";
        saveBytecode(outputPath, bytecode);

        console.log("  " + baseName + ": " + source.length + " bytes -> " + bytecode.length + " bytes");
    }

    console.log("");
    console.log("Total: " + totalSource + " source bytes -> " + totalBytecode + " bytecode bytes");
    let ratio = 0;
    if (totalSource > 0) {
        ratio = (totalBytecode / totalSource) * 100;
    }
    console.log("Compression: " + ratio.toFixed(1) + "%");
    console.log("");

    let combinedSource = "";
    for (let i = 0; i < BOOTSTRAP_MODULES.length; i++) {
        combinedSource = combinedSource + fs.readFileSync(BOOTSTRAP_MODULES[i], "utf8") + "\n\n";
    }

    let combinedBytecode = compileToBytecode(combinedSource);
    if (combinedBytecode == null) {
        console.log("FAIL: Self-compilation failed");
        return false;
    }

    let combinedPath = outputDir + "/combined.bc";
    saveBytecode(combinedPath, combinedBytecode);

    console.log("Combined: " + combinedSource.length + " bytes -> " + combinedBytecode.length + " bytes");
    console.log("");
    console.log("Output files in: " + outputDir);
    console.log("");
    console.log("==============================================");
    console.log("Full Bootstrap: PASS");
    console.log("==============================================");

    return true;
}

let loopResult = testBootstrapLoop();
let hashResult = testHashVerification();
let fullResult = testFullBootstrap();

console.log("");
console.log("==============================================");
console.log("Hash Match Verification Test");
console.log("==============================================");
console.log("");

console.log("Verifying that multiple compilations produce identical bytecode...");

function testHashMatchVerification() {
    let hashMatchPassed = true;

    console.log("Testing individual modules...");
    for (let i = 0; i < BOOTSTRAP_MODULES.length; i++) {
        let modulePath = BOOTSTRAP_MODULES[i];
        let source = fs.readFileSync(modulePath, "utf8");

        let bcA = compileToBytecode(source);
        let lenA = bcA.length;
        let hA = computeBytecodeHash(bcA);

        let bcB = compileToBytecode(source);
        let lenB = bcB.length;
        let hB = computeBytecodeHash(bcB);

        let hashesMatch = hA == hB;
        let lensMatch = lenA == lenB;

        if (hashesMatch && lensMatch) {
            let baseName = modulePath.replace("../bootstrap/", "").replace(".tscl", "");
            console.log("  " + baseName + ": " + hA.toString(16) + " (MATCH)");
        } else {
            let baseName = modulePath.replace("../bootstrap/", "").replace(".tscl", "");
            console.log("  " + baseName + ": MISMATCH");
            hashMatchPassed = false;
        }
    }

    console.log("Testing combined source...");
    let combinedSource = "";
    let moduleCount = 0;
    for (let j = 0; j < BOOTSTRAP_MODULES.length; j++) {
        combinedSource = combinedSource + fs.readFileSync(BOOTSTRAP_MODULES[j], "utf8") + "\n\n";
        moduleCount = j + 1;
    }

    let scA = compileToBytecode(combinedSource);
    let slenA = scA.length;
    let shA = computeBytecodeHash(scA);

    let scB = compileToBytecode(combinedSource);
    let slenB = scB.length;
    let shB = computeBytecodeHash(scB);

    let combinedMatch = shA == shB && slenA == slenB;
    console.log("  Combined (" + moduleCount + " modules): " + shA.toString(16) + " vs " + shB.toString(16) + " " + (combinedMatch ? "(MATCH)" : "MISMATCH"));

    if (!combinedMatch) {
        hashMatchPassed = false;
    }

    console.log("");
    console.log("==============================================");
    if (hashMatchPassed) {
        console.log("Hash Match Verification: PASS");
        console.log("");
        console.log("The bootstrap compiler is DETERMINISTIC!");
    } else {
        console.log("Hash Match Verification: FAIL");
    }
    console.log("==============================================");

    return hashMatchPassed;
}

let hashMatchResult = testHashMatchVerification();

console.log("");
console.log("==============================================");
console.log("Summary");
console.log("==============================================");
console.log("Bootstrap Loop: " + (loopResult ? "PASS" : "FAIL"));
console.log("Hash Verification: " + (hashResult ? "PASS" : "FAIL"));
console.log("Full Bootstrap: " + (fullResult ? "PASS" : "FAIL"));
console.log("Hash Match: " + (hashMatchResult ? "PASS" : "FAIL"));
console.log("==============================================");
